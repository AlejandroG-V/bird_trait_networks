---
title: "R02: Duplicates in Table.xls and other minor issues"
author: "Anna Krystalli"
date: "19 January 2016"
output: html_document
---


```{r, echo=FALSE, warning=FALSE, message=F}

### SETTINGS ##############################################################

output.folder <- "/Users/Anna/Google Drive/bird trait networks/outputs/"
input.folder <- "/Users/Anna/Google Drive/bird trait networks/inputs/data/"
script.folder <- "/Users/Anna/Documents/workflows/bird_trait_networks/"

write_dups <- T

### FUNCTIONS ##############################################################

require(dplyr)
require(plotly)
require(knitr)
require(RColorBrewer)

numerise <- function(x){if(all(grepl('^[0-9.]+$', x))) as.numeric(x) else x}

### FILES ##############################################################

metadata <- read.csv(paste(input.folder, "metadata/","metadata.csv", sep = ""), 
                     stringsAsFactors = F, fileEncoding = "mac") %>% 
  apply(2, FUN = trimws) %>% data.frame(stringsAsFactors = F)


vnames <- read.csv(paste(input.folder, "metadata/","vnames.csv", sep = ""), 
                   stringsAsFactors = F, fileEncoding = "mac") %>% 
  apply(2, FUN = trimws) %>% data.frame(stringsAsFactors = F)
vnames[vnames == ""] <- NA

```

 
## Discrepancies in the **```D1```** dataset:
I noticed potential issues arising from differences in the number of references used to determine an overall value per species per variable in the **`D1`** dataset. I investigated the discrepancy in the **male** vs **female** **`age at maturity`** (see **R01 plot**) for ***Rhea americana***. It is the **male** value that is clearly wrong (*4260* should have been *426.0* days according to the single source referenced in the [Amniote paper]()). However, the general impression I got from my initial literature search is that *female maturity was generally, if not the same, shorter than male*. [Some websites](http://aviansag.org/Fact_Sheets/Ratites/Greater_Rhea.pdf) -to which I couldn't access the original book sources- quote [**female 2 yrs** and **males 3**](http://www.arkive.org/greater-rhea/rhea-americana/), others females as short as [**10-12 months**](http://www.beautyofbirds.com/greaterrheas.html). However, because **female maturity** was determined from about *10* different sources in **`D1`**, in contrast to the *single* source used for **male maturity** it is actually longer (*576.468*). Therefore the calculated variable **`repro.age.diff`** (female - male maturity) is *positive* rather than *negative*. I only mention this because I have a feeling **`repro.age.diff`** might be related to the rather unique mating system they appear to have and that a *zero* or *negative* value might be more biologically accurate. I'll look out for it as an outlier if in the **`repro.age.diff`** correlations. Also I guess it serves as a demonstration of how discrepanscies can arise when trying to relate varriables based on different numbers of sources. Food for thought!


<br>

***

## Reprocessing **``D0``** from **`Table.xls`**

```{r, echo=FALSE}
D0 <- read.csv(paste(input.folder,"csv/D0.csv", sep= ""), stringsAsFactors = F, fileEncoding = "mac") %>% 
  apply(2, FUN = trimws) %>% data.frame(stringsAsFactors = F)
```




I processes **`Table.csv`** (generated by saving **`Table.xls`** to **`.csv`**), following the same process developed for the **`Tabla.csv`** in script [**`process D0.R`**](https://github.com/annakrystalli/bird_trait_networks/blob/master/process%20D0.R). 

### Issues:

#### Raw data error in **Variable** field 
An error was noted in **`Table.xls`** in the **Variable** field for ***Branta sandvicensis***.

```{r, echo=FALSE}

k <- 1

table <- read.csv(paste(input.folder,"csv/Table.csv", sep= ""), stringsAsFactors = F, fileEncoding = "mac") %>% 
  apply(2, FUN = trimws) %>% data.frame(stringsAsFactors = F)

r <- which(is.na(match(table$Variable , vnames$D0)))
kable(table[r,1:9])
```

**Reference**

```{r, echo=FALSE}

table[r, "Reference"]
```
I went back to the [data](http://www.ncbi.nlm.nih.gov/pmc/articles/PMC2429933/bin/rsbl20070606s01.doc) from the [original paper](http://www.ncbi.nlm.nih.gov/pmc/articles/PMC2429933/), determined the correct variable to be ***age at first reproduction*** and corrected **`D0`** accordingly.


<br>
<br>

***

# Duplicates in **`D0`**

There some duplication issues in the new **`Table.csv`**. 



### Dupicate variables
Firstly, there appears to be duplication of a few variables.

```{r, echo=FALSE}

k <- k+1
dup.var <- vnames[vnames$code %in% vnames$code[which(duplicated(vnames$code))],]

kable(dup.var[order(dup.var$code),], row.names = F, caption = paste("T.",k,".", 1, ": Duplicate variables", sep = ""))
```


The duplicate **`D0`** variables **for code variable **`habitat.for`** are clearly the result of a capitalisation typos. Other seem to arising from using alternative variable names for the same variable. The vars **`vitE.liver`** and **`caroten.liver`** have completely consistent data (see T3.2)

```{r, echo=FALSE}
dup.ref <- unique(D0[D0$var %in% dup.var$code, c("var", "ref")])

kable(dup.ref[order(dup.ref$var),], row.names = F, caption = paste("T.",k,".", 2, ": Duplicate variable references", sep = ""))

```



***

### Duplicate var x species data

There is a large number of duplicate variable entries per species,

```{r, echo=FALSE}

k <- k+1

dups <- rbind(D0[duplicated(D0[,c("species", "var")]),],
      D0[duplicated(D0[,c("species", "var")], fromLast = T),])
  dups <- dups[order(dups$var, dups$species),c("species", "var", "value", "units", "ref")]
  vars <- unique(dups$var)

  # duplicate no.
kable(data.frame(duplicates = dim(dups)[1]/2, total = dim(D0)[1], proportion_duplicate =
                   (dim(dups)[1]/2)/dim(D0)[1]), digits = c(0,0,3),
      caption = paste("T.",k,".", 1, ": Number of duplicate var x species entries ", sep = ""))
```

These duplicates are spread across **44 variables**. Some related to the duplicate variables identified above. In about **a third** of variables, duplicate **values are consistent** and represent either unique data points duplicated across sources or duplicate but consistent measurements or scorings. Hard to know which. The rest however include divergent data **(T3.2)**.


```{r, echo=FALSE, results='asis'}

    # unique duplicate entries per var 
  dval.dd<- unique(dups[,c("species", "var", "value")])

vardups <- data.frame(aggregate(dval.dd[,"species"], by = list(dval.dd$var), 
                                FUN = function(x){sum(!x %in% x[duplicated(x)])/length(x)*100}),
                      aggregate(dval.dd[,"species"], by = list(dval.dd$var), 
                                FUN = function(x){length(x)})[,"x"])

vardups <- vardups[rev(order(vardups$x)),]
names(vardups) <- c("var", "unique", "n")

kable(vardups, col.names = c("var", "% duplicates consistent", "n"), digits = c(2,0), row.names = F,
      caption = paste("T.",k, ".",2, ": Proportion of consistent duplicate entries across variables", 
                      sep = ""))

```


<br>
<br>

***

## **`Divergent Data`**

I've printed the divergent data for you to get a feel for it. I considered trying to develop a sort of observer correspondence metric but for many variables the number of data points available for comparison is small and the proportion of datapoints affected is so low it doesn't seem worth the effort at this point. However it depends what we decide to do about duplicates in this project, and also how you want to deal with it for publication.

#### **`Options`**

In terms of this project we have two options.

  - **Just remove duplicates** : 
  
      + a decision needs to be made on which duplicates are to be deleted, esp. in the case of divergent duplicates
       + carry on as scheduled by adding only non overlapping **`D1`** data. This would definitely be the simplest option. 
  - Allow duplicates, 
      + add all **`D1`** data 
      + use summaries of available **data x species** entries. 
          - However, this would significantly add to the proportion of duplicate data, indeed the data set would have 60% duplicates. 
          - It would probably be important to determine the correspondence between mutiple **data x species** entries. 
          
Have a look at the tables below to get a feel for the duplicates and let's discuss how we want to proceed

***



```{r, echo=FALSE, results='asis'}
k <- k+1

vars <- rev(vardups$var[vardups$unique < 100])

#length(vars)
 for(i in 1:length(vars)){
var <- vars[i]
#printDupTables <- function(dups, var, k, i){
  
  # Print details of duplicate entries per var including references
  #kable(unique(dups[dups$var == var,][,c("species", "ref")]), row.names = F, 
       # caption = paste("T", k, ".1: Sources of duplicate entries in data for var: ", var, sep=""))
  


  dspp <- dval.dd$species[duplicated(dval.dd$species)]
  
  if(length(dspp) == 0){
    #print(paste("T", k, ".",i,": ", "No divergent duplicate data for var: ", var, sep = ""))
  }else{

  # Print spp and divegent duplicate entries per var
  
  #print(kable(dspp))
    
    
    
 print(kable(data.frame(lapply(dups[dups$species %in% dspp & dups$var == var,], FUN = numerise)),
             row.names = F, caption = paste("T", k, ".",i,": Divergent duplicate entries for var: ",
                                            var, sep=""),
             digits = if(metadata$type[metadata$master.vname == var] == "Con"){2}else{0}))
  }
  }



#length(vars)
 #for(i in 3){
 #printDupTables(dups, var = vars[i], k = 2, i = i)
 #  printDupTables(dups, var =  "bmr", k = 2, i = which(vars == "bmr"))
  #}

```

<br>
<br>

***

### APPENDIX
```{r, echo=FALSE}

k <- k+1

if(write_dups){
  write.csv(dups, file = paste(input.folder, "r data/Table_duplicates.csv", sep = ""), 
            row.names = F, fileEncoding = "mac")
}

#print table of all duplicates
kable(dups, row.names = F, caption = paste("T.",k,"1: Duplicated species variable entries", 
                                           sep= ""))

```


                
          
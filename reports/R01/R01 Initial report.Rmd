---
title: "R01: Initial report"
author: "Anna Krystalli"
date: "11 December 2015"
output: html_document

---

## Initial processing

The `Tabla.xls` provided was cleaned and the variables names in column `var` were re-assigned codes for ease of processing, the details of which can be found in the [**`metadata.csv`**](https://drive.google.com/open?id=0B9BMeZ9H2nRxdWlhUXZUWVhtcE0) sheet I adapted from information supplied in the second `Tabla.xls` tab. The final `data.frame` was saves as [**`D0.csv`**](https://drive.google.com/open?id=0B9BMeZ9H2nRxYnhQdGxCQUxISkU). 

The `Amniote_Database_Aug_2015.csv` was also cleaned and subset to `class` == `Aves`. Any variables with no data for `Aves` were removed. The taxonomic information was separated and saved as [**`taxo.csv`**](https://drive.google.com/open?id=0B9BMeZ9H2nRxYlNzaGVxRkZwUHM). The final `data.frame` was saved as [**`D1`**](https://drive.google.com/open?id=0B9BMeZ9H2nRxakVQUHloNmF1S2M).

The `species` column in both datasets was reformatted as **genus_species**. Variable name correspondence of both datasets to the coded variables can be found in [**`vnames.csv`**](https://drive.google.com/open?id=0B9BMeZ9H2nRxOFg4aVh2SDJ2dDA).





***



```{r, echo=F, message=FALSE, warning=F}

options(stringsAsFactors = F)


### SETTINGS ##############################################################

codewd <- "~/Documents/worflows/bird_trait_networks/"
datawd <- "~/"

output.folder <- "/Users/Anna/Google Drive/bird trait networks/outputs/"
input.folder <- "/Users/Anna/Google Drive/bird trait networks/inputs/data/"


### FUNCTIONS ##############################################################

require(dplyr)
require(plotly)
require(knitr)
require(RColorBrewer)

numerise <- function(x){if(all(grepl('^[0-9.]+$', x))) as.numeric(x) else x}

makeTransparent<-function(someColor, alpha=100)
{
  newColor<-col2rgb(someColor)
  apply(newColor, 2, function(curcoldata){rgb(red=curcoldata[1], green=curcoldata[2],
                                              blue=curcoldata[3],alpha=alpha, maxColorValue=255)})
}

#source("~/Documents/worflows/bird_trait_networks/Setup.R")

metadata <- read.csv(paste(input.folder, "metadata/","metadata.csv", sep = ""), 
                     stringsAsFactors = F, fileEncoding = "mac") %>% 
  apply(2, FUN = trimws) %>% data.frame(stringsAsFactors = F)


vnames <- read.csv(paste(input.folder, "metadata/","vnames.csv", sep = ""), 
                   stringsAsFactors = F, fileEncoding = "mac") %>% 
  apply(2, FUN = trimws) %>% data.frame(stringsAsFactors = F)
vnames[vnames == ""] <- NA
#____________________________________________________________________________
### Check D1 against d0 data ###

# Load files

D0 <- read.csv(file = paste(input.folder, "csv/","D0.csv", sep = "")
                            ,fileEncoding = "mac")                    
D1 <- read.csv(file = paste(input.folder, "csv/","D1.csv", sep = ""),
                            fileEncoding = "mac") 


# check species name overlap
#sum(D0$species %in% D1$species)/length(D0$species)

D1 <- D1[D1$species %in% D0$species,]

# calculate straight match variables
compare.ids <- which(vnames$D1 %in% names(D1))
```

## **`D0`** and **`D1`** match assessment

<br>

### Shared variable match assessment

Approx **82%** (3864) of **`D0`** species matched onto **`D1`** species. **`D1`** was subsquently subset to species shared between the two datasets. Of the variables available in **`D1`**, **10** appear to have a straight match to **`D0`** variables. 


```{r, echo=F, message=FALSE, warning=F}

kable(vnames[compare.ids,c("code","D0", "D1")])
```

Some variables also appear to have a number of variable that could be matched.

<br>

##### Age at first reproduction

The **`D0`** variable **`reproductive age`**, has a number of **`D1`** variables that could be matched, namely:
**`female_maturity_d`**, **`male_maturity_d`**, and **`no_sex_maturity_d`**. Male & female maturity show similar distributions. The unsexed data though shows significant deviations, most likely due to the much smaller data availabity.

```{r, echo=F, message=FALSE, warning=F}

# maturity histograms
n <- c()

for(i in grep("maturity", names(D1))){
  x <- na.omit(D1[,i])
  n <- c(n, length(x))
  
  if(i == 2){
    hist(x, freq = F, col = makeTransparent(i, 20), 
         border = makeTransparent(i, 40), main = "",
         xlab = names(D1)[i])}else{
           hist(x, freq = F, col = makeTransparent(i, 20), 
                border = makeTransparent(i, 40),
                add = T)
         }
    
}
legend("topright",fill = makeTransparent(grep("maturity", names(D1)), 40), 
       legend = paste(grep("maturity", names(D1), value = T), " (n = ", n,")", sep = ""), 
                      cex = 0.6)


# maturity scatterplot (correlation)

ids <- D1[grep("maturity", names(D1))[1:2]] %>% complete.cases()
female_maturity_d <- D1[ids, grep("maturity", names(D1))[1]]
male_maturity_d <- D1[ids, grep("maturity", names(D1))[2]]



  p <- plot_ly(x = female_maturity_d, y = male_maturity_d, hoverinfo = "x+y+text", 
                text = D1$species[ids], type = "scatter", mode = "markers", 
                colorscale = "Greens", reversescale = T, 
                marker = list(
                  color = toRGB("aquamarine2"), opacity = 0.5, size = 6,
                            line = list(
                              color = toRGB("aquamarine4"), 
                              width = 0.5)
                  ))
  p

```

Indeed, male & female correlate well, although note the obvious outlier in *Rhea_americana* in **`male_maturity_d`** (you cam zoom into plot and hover over for details). So at the minute I have opted to focus on **`female_maturity_d`**. I'm not sure there is much point in adding the male data as a separate variable as clearly they will generally correlate. My only suggestion would be to perhaps include the *difference* between age of maturity of the two sexes.


The **`D0`** and **`D1`** variables are at different resolutions (years and days). Seeing as **`D1`** contains **972** datapoints on  **`female_maturity_d`**, doubling data availability on the variable from **502** to **1065** and can also provide values for over 90% of species in the dataset, I've opted to transform the **`D0 repro.age`** from years to days, to match **`D1`** resolution.

<br>

##### Body mass

Although I have matched  **`D0 body mass`** to **`D1`** variable **`adult_body_mass_g`**, **`D1`** also contains another potential variable **`no_sex_body_mass_g`**. When comparing the two variables it is clear that **`no_sex_body_mass_g`** would not add data for any additional species (combined n = `adult_body_mass_g` n) and correlates extremely closely (>99%) with **`adult_body_mass_g`**. I therefore suggest we disregard it.


```{r, echo=F, message=FALSE, warning=F}

# body mass
  
n <- c()

  vars <- c("adult_body_mass_g", "no_sex_body_mass_g")

  ids <- match(vars, names(D1)) 
  
  for(i in ids){
    
    x <- log(na.omit(as.numeric(D1[,i])))
    n <- c(n, length(x))
    
    if(i == ids[1]){
      hist(x, freq = F, col = makeTransparent(i, 20), 
           border = makeTransparent(i, 40), 
           main = paste("combined n =", length(unique(c(D1$species[!is.na(D1$adult_body_mass_g)],
                                               D1$species[!is.na(D1$no_sex_body_mass_g)])))),
           xlab = names(D1)[i])}else{
             hist(x, freq = F, col = makeTransparent(i, 20), 
                  border = makeTransparent(i, 40),
                  add = T)
           }
      
  }
legend("topright",fill = makeTransparent(ids, 40), 
       legend = paste(names(D1)[ids], " (n = ", n,")", sep = ""), 
                      cex = 0.6)


# maturity scatterplot (correlation)

ids <- D1[,match(vars, names(D1))] %>% complete.cases()
adult_body_mass_g <- as.numeric(D1[ids, "adult_body_mass_g"])
no_sex_body_mass_g <- as.numeric(D1[ids, "no_sex_body_mass_g"])



  p <- plot_ly(x = adult_body_mass_g, y = no_sex_body_mass_g, hoverinfo = "x+y+text", 
                text = D1$species[ids], type = "scatter", mode = "markers", 
                colorscale = "Greens", reversescale = T, 
                marker = list(
                  color = toRGB("aquamarine2"), opacity = 0.5, size = 6,
                            line = list(
                              color = toRGB("aquamarine4"), 
                              width = 0.5)
                  ))
  p

```



<br>

#### Comparison of **`D0`** & **`D1`** data distributions

The following plots show the distribution of  **`D0`** & **`D1`** data for each variable to be matched as well as the relationship of D0 vs D1 datapoints for individual species where data overlap. 
```{r, echo=F, message=FALSE, warning= F, fig.height = 4, fig.width= 8}

par(mfrow = c(1,2))
  
# D1 vs D0 Histograms

bins <- 20
outlie.df <- c()

for(i in 1:length(compare.ids)){
  
  D0var <- vnames$code[compare.ids][i]
  D1var <- vnames$D1[compare.ids][i]
  
  type <- metadata$type[metadata$master.vname == D0var]
  
  D0dat <- numerise(na.omit(D0[D0$var == vnames$code[compare.ids][i], "value"]))
  D1dat <- numerise(na.omit(D1[,vnames$D1[compare.ids][i]]))
  
  if(length(grep("body", D0var, value = F)) != 0){
    D0dat <- log(D0dat)
    D1dat <- log(D1dat)
  }
  
    
    range <- range(c(D0dat, D1dat))
    breaks <- seq(range[1], range[2], length.out = bins)
    
     # plot D0 data
    hist(D0dat, breaks = breaks, freq = F, col = makeTransparent("red", 20), 
         border = makeTransparent("red", 40), 
         main = paste("n0 = ", length(D0dat), ",     n1 = ", length(D1dat), ",     n.total = ",
                      length(unique(c(D1$species[!is.na(D1[,D1var])], 
                                      D0$species[D0$var == D0var]))),
                      "   (+",round((length(unique(c(D1$species[!is.na(D1[,D1var])],
                                                    D0$species[D0$var == D0var]))) - 
                                      length(D0dat))/length(D0dat),2)*100,
                      "%)",
                      sep = ""), cex.main = 0.8,
         xlab = paste(if(length(grep("body", D0var, value = F)) != 0){"log"}else{""},
           metadata$descr[metadata$master.vname == D0var], 
           metadata$unit[metadata$master.vname == D0var]))
    
    # add D1 data
    hist(D1dat, breaks = breaks, freq = F, add = T, col = makeTransparent("blue", 20), 
         border = makeTransparent("blue", 40))
    legend("topright",fill = makeTransparent(c("red", "blue"), 20), 
       legend = c("D0", "D1"), cex = 1, bty = "n", 
       border = makeTransparent(c("red", "blue"), 40))
  

    # D1 vs D0 Scatterplot......................................................
    
          spp <- intersect(D0$species[D0$var == D0var], D1$species[!is.na(D1[,D1var])])
          D1.var <- as.numeric(D1[match(spp, D1$species), D1var])
          D0.var <- as.numeric(D0$value[D0$var == D0var][
            match(spp, D0$species[D0$var == D0var])])
    
    plot(x = D0.var, y = D1.var, xlab = D0var, ylab = D1var, cex.main = 0.8, 
         main = paste("n =", length(spp)), col = "aquamarine2", pch = 21,
         bg = makeTransparent("aquamarine2", 60), cex = 0.8, 
         ylim = range(c(D0.var, D1.var)), 
         xlim = range(c(D0.var, D1.var)))
    
    abline(a = 0, b = 1, col = makeTransparent("aquamarine2", 90), lwd = 2)
                        

   # compile ouliers
    
        if(D0var != "bill.len"){
          df <- cbind(D0.var, D1.var)
          outliers <- apply(df, 1, FUN = 
                              function(x){any(abs(diff(x))/x[which(x == min(x))] > 2)})
          outlie.df <- rbind(outlie.df, cbind(species = spp, var = D0var, df)[outliers,])
          } 
    
}
  

  
  
  par(mfrow = c(1,1))

 
```

Overall, **`D1`** data for most variables appear to be consistent with the **`D0`** data, in terms of overall the distribution, as well as in the correspondence of data where species overlap the two datasets.  However, a few concerns need to be address before proceeding. The plots for **`D0`** variable **`bill length`** show a shifted distribution to the right in **`D1`** with significant disparity in the lowest bin. When plotted against each other, overlapping data also show complete deviations from a 1:1 relationship. Snout-to-vent measurements do not therefore correspond well with **`bill length`** so **`D1`** variable  **`adult_svl_cm`** is not a suitable match for **`bill length`**. (You probably knew this already but I wasn't sure!; note I have corrected for the difference in units by multiplying the **`adult_svl_cm`** *cm* data by *10* to match *mm* units of **`bill length`**. Oddly the two variables corresponded much better without this transformation)

**`D0`** variables **`repro.age`**, **`clutch.no`**, **`clutch.size`**,  **`inc`** show generally good correspondence in overlapping data although some obvious outliers can be seen. Below, I've highlighted any point in which the difference between **`D0`** and **`D1`** values is **>3** times the smallest value of the two. Some may be  data entry errors (e.g. in decimal places) but it is generally not obvious which dataset is correct so  I will try and validate these datapoints against the literature. Please let me know if you can shed any light on these spurious data points.

##### outliers
```{r, echo=F, message=FALSE, warning= F, fig.height = 4, fig.width= 8}
  kable(outlie.df, digits = 2, row.names = F)
  write.csv(outlie.df, "/Users/Anna/Google Drive/bird trait networks/inputs/data/r data/outliers.csv", row.names = F)

 
```


<br>

I have taken your request to not *extend* the dataset to mean you don't want me to add more species to the data. As such, I've subset **`D1`** data by species found in **`D0`**.  I'd like to clear up what to do with duplicate data. I could add all data and just take the mean/mode of duplicates. Or I could either choose to stick with  **`D0`** or update with **`D1`**.

<br>

#### Additional variables

There are however a number more variables in **`D1`** that could be added to the dataset, most with a decent number of datapoints, especially compared to many **`D0`** variables.


```{r, echo=F, message=FALSE}
  
  D1meta <- read.csv(paste(input.folder, "metadata/D1.csv", sep = ""), stringsAsFactors = F,
                     fileEncoding = "mac") %>% 
  apply(2, FUN = trimws) %>% data.frame(stringsAsFactors = F)
  
  extra <- D1meta$match %in% c("n", "d") & D1meta$var %in% names(D1)
  
  kable(data.frame(D1meta[extra,1:2], n = apply(D1[,D1meta$var[extra]], 2, FUN = function(x){
    sum(!is.na(x))
  })), row.names = F)
  
```
<br>

***

## **`D0`** exploration

<br>


#### Data availability counts for **`D0`** variables


```{r, echo=F, message=FALSE, warning= F}


vcount <- split(D0$species, f = D0$var) %>% lapply(FUN = length)
dfcount <- data.frame(var = names(vcount), 
                      descr = metadata$descr[match(names(vcount), metadata$master.vname)],
                      cat = metadata$cat[match(names(vcount), metadata$master.vname)],
                      type = metadata$type[match(names(vcount), metadata$master.vname)],
                      count = unlist(vcount), row.names = NULL) 
dfcount <- dfcount[order(dfcount$count, decreasing = T),]
kable(dfcount, format = "markdown", align = "l", row.names = F)


```

<br>

### Data availability across **`D0`** bivariate combinations

I've also calculated counts of data available for all variable combinations. Below is the distribution of counts across all bivariable combination.



```{r, echo=F, message=FALSE, warning= F}

load(file = paste(input.folder, "r data/n.comb.Rdata", sep = ""))

# make grid with unique combinations of variables
var.grid <- expand.grid(unique(D0$var), unique(D0$var))


# make matrix
m <- matrix(NA, ncol = length(unique(D0$var)), nrow = length(unique(D0$var)),
            dimnames = list(unique(D0$var), unique(D0$var)))

m[cbind(var.grid[,1], var.grid[,2])] <- n.comb

plot_ly(x = n.comb, type = "histogram")

cat <- metadata$cat[match(dimnames(m)[[1]], metadata$master.vname)]
text <- cat[order(cat)]

m <- m[order(cat),order(cat)]
```


I've also plotted interactively the matrix of bivariable counts, sorted by variable category (let me know if you want me to sort the matrix some other way):


```{r, echo=F, message=FALSE, warning= F}
col <- brewer.pal(5, "YlGnBu")

plot_ly(z = m, x = unique(D0$var), y = unique(D0$var), type = "heatmap", 
        #color = col,
        colors = colorRamp(col, bias = 2),
        hoverinfo = "z+x+y+text", text = text) %>%

layout(margin = list(l = 150,
                     r = 80,
                     b = 120,
                     t = 60)) 

```
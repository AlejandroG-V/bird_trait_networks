---
title: "R05 PhyloCors 100spp"
author: "Anna Krystalli"
date: "7 March 2016"
output: html_document
---

## Testing full data processing times

The biggest number of available species data availability (***3645***) is for variable combination  **clutch.size** vs **body.mass** took **1.989042 hours** to run the pgls! Result FYI: lambda = 0.8471502, **phylocor2 = 0.004471414**.

## **SUBSET TO 100 SPECIES**

I subset the data according to the species list you supplied and variable combinations with atleast **3 datapoints**. This more than tripled the number of variable combinations available but significantly changed the structure of the network as well. So I've rerun the report as is for your information and regenerated the matrix with the full variable combinations on plotly. In **section 2** however, I fit the network again by restricting to variable combinations with **10, 20, 30 and 40 available data points** so you can see how network structure changes as we exclude variables combinations for which Plenty to think about!

I have logged values for the following variables:


```{r, echo=F, message=FALSE, warning= F}
require(knitr)
require(RColorBrewer)
require(dplyr)
require(plotly)

options(scipen=999)
options(stringsAsFactors = F)

  codewd <- "~/Documents/worflows/bird_trait_networks/"
  datawd <- "~/"
  output.folder <- "/Users/Anna/Google Drive/bird trait networks/outputs/"
  input.folder <- "/Users/Anna/Google Drive/bird trait networks/inputs/data/"

  metadata <- read.csv(paste(input.folder, "metadata/","metadata.csv", sep = ""), 
                     stringsAsFactors = F, fileEncoding = "mac") %>% 
  apply(2, FUN = trimws) %>% data.frame(stringsAsFactors = F)
  
  spp100 <- unlist(read.csv(file = paste(input.folder,"csv/100spp.csv", sep= "")))
  res <- read.csv(paste(output.folder, "data/phylocors/100spp phylocor log.csv", sep = ""))
  net <- read.csv(paste(output.folder, "data/networks/100spp network log.csv", sep = ""))

  print(sort(unique(c(grep("log", res$var1, value = T), grep("log", res$var2, value = T)))))

```

After logging, the number of failed conversions of the model were 278/14014 (2%). Here's a list of variable combinations for which models did not converge:


```{r, echo=F, message=FALSE, warning= F}

kable(res[is.na(res$phylocor),])
```


Interactive matrix plot updated on [plotly](https://plot.ly/~akrystalli/390/matrix-of-bivariate-phylocorrected-correlations/?share_key=qHQ5Ly08slumcssaIySgU2)


```{r, echo=F, message=FALSE, warning= F}
 vars <- unique(c(res$var1, res$var2))


# make matrix
m <- matrix(NA, ncol = length(vars), nrow = length(vars),
dimnames = list(vars, vars))
m[cbind(res[,1], res[,2])] <- res$phylocor
m[cbind(vars, vars)] <- 1

# order by categories
cat <- metadata$cat[match(gsub("log_", "", dimnames(m)[[1]]), metadata$master.vname)]

 cum.cor <- c() 
  for(var in dimnames(m)[[1]]){
   cum.cor <- c(cum.cor, mean(abs(res$phylocor[res$var1 == var | res$var2 == var]), na.rm = T))
  }

m.order <- order(cum.cor, decreasing = T)
labels <- paste(substr(cat, 1,2), dimnames(m)[[1]])[m.order]

m <- m[rev(m.order),m.order]

col <- rev(brewer.pal(9, "RdBu"))

plot_ly(z = m, x = labels, y = rev(labels), type = "heatmap", 
        #color = col, 
        name = "phylocorrected correlations",
        colors = col,
        hoverinfo = "z+x+y") %>%
  
  layout(margin = list(l = 150,
                       r = 80,
                       b = 120,
                       t = 60),
         title = "Matrix of bivariate phylocorrected correlations",
         xaxis = list(title = ""),
         yaxis = list(title = "")) 

```



## SECTION 2 - COMPARISON OF NETWORKS

As mentioned above I've varied the minimum data availability (n) for which variable combinations are included in network costruction. I've as a start just displayed a few simple metrics, made a bar chart of the distribution of different node types within each network and printed the table of netwrok characteristics (ordered by variable participation) for you to get an idea of changes in variable structures as fewer (but more reliable) associations between variables are used to construct networks. Still working on a nice visualation method, probably a simpler one for a comparison report like this but a more elaborate interactive one for better network exploration.


#### Minimum n = 3
```{r, echo=F, message=FALSE, warning= F}

library(rnetcarto)

min.n <- 3
net.d <- res[!is.na(res$phylocor), c("var1", "var2", "phylocor", "n")]
net.d <- net.d[net.d$n > min.n, -4]
net.list <- as.list(net.d)
network <- netcarto(web = net.list, seed = 2)
net <- network[[1]]

  print(paste("minimum number of datapoints allowed to include variable combinations in network:",
              min.n))
  print(paste("number of variable combinations in network:", dim(net.d)[1]))
  print(paste("number of modules in network:", length(unique(net$module))))

par(las = 2, mar = c(8,4,1,1))
barplot(table(net$role)/sum(table(net$role)))
```

```{r, echo=F, message=FALSE, warning= F, results = "asis"}
print(kable(net[order(net$participation, decreasing = T),]))


```

#### Minimum n = 10
```{r, echo=F, message=FALSE, warning= F}

min.n <- 10
net.d <- res[!is.na(res$phylocor), c("var1", "var2", "phylocor", "n")]
net.d <- net.d[net.d$n > min.n, -4]
net.list <- as.list(net.d)
network <- netcarto(web = net.list, seed = 2)
net <- network[[1]]

  print(paste("minimum number of datapoints allowed to include variable combinations in network:",
              min.n))
  print(paste("number of variable combinations in network:", dim(net.d)[1]))
  print(paste("number of modules in network:", length(unique(net$module))))

par(las = 2, mar = c(8,4,1,1))
barplot(table(net$role)/sum(table(net$role)))
```

```{r, echo=F, message=FALSE, warning= F, results = "asis"}
print(kable(net[order(net$participation, decreasing = T),]))

```

#### Minimum n = 20
```{r, echo=F, message=FALSE, warning= F}

min.n <- 20
net.d <- res[!is.na(res$phylocor), c("var1", "var2", "phylocor", "n")]
net.d <- net.d[net.d$n > min.n, -4]
net.list <- as.list(net.d)
network <- netcarto(web = net.list, seed = 2)
net <- network[[1]]

  print(paste("minimum number of datapoints allowed to include variable combinations in network:",
              min.n))
  print(paste("number of variable combinations in network:", dim(net.d)[1]))
  print(paste("number of modules in network:", length(unique(net$module))))

par(las = 2, mar = c(8,4,1,1))
barplot(table(net$role)/sum(table(net$role)))
```

```{r, echo=F, message=FALSE, warning= F, results = "asis"}
print(kable(net[order(net$participation, decreasing = T),]))

```


#### Minimum n = 20
```{r, echo=F, message=FALSE, warning= F}

min.n <- 20
net.d <- res[!is.na(res$phylocor), c("var1", "var2", "phylocor", "n")]
net.d <- net.d[net.d$n > min.n, -4]
net.list <- as.list(net.d)
network <- netcarto(web = net.list, seed = 2)
net <- network[[1]]

  print(paste("minimum number of datapoints allowed to include variable combinations in network:",
              min.n))
  print(paste("number of variable combinations in network:", dim(net.d)[1]))
  print(paste("number of modules in network:", length(unique(net$module))))

par(las = 2, mar = c(8,4,1,1))
barplot(table(net$role)/sum(table(net$role)))
```

```{r, echo=F, message=FALSE, warning= F, results = "asis"}
print(kable(net[order(net$participation, decreasing = T),]))

```

#### Minimum n = 30
```{r, echo=F, message=FALSE, warning= F}

min.n <- 30
net.d <- res[!is.na(res$phylocor), c("var1", "var2", "phylocor", "n")]
net.d <- net.d[net.d$n > min.n, -4]
net.list <- as.list(net.d)
network <- netcarto(web = net.list, seed = 2)
net <- network[[1]]

  print(paste("minimum number of datapoints allowed to include variable combinations in network:",
              min.n))
  print(paste("number of variable combinations in network:", dim(net.d)[1]))
  print(paste("number of modules in network:", length(unique(net$module))))

par(las = 2, mar = c(8,4,1,1))
barplot(table(net$role)/sum(table(net$role)))
```

```{r, echo=F, message=FALSE, warning= F, results = "asis"}
print(kable(net[order(net$participation, decreasing = T),]))

```

#### Minimum n = 40
```{r, echo=F, message=FALSE, warning= F}

min.n <- 40
net.d <- res[!is.na(res$phylocor), c("var1", "var2", "phylocor", "n")]
net.d <- net.d[net.d$n > min.n, -4]
net.list <- as.list(net.d)
network <- netcarto(web = net.list, seed = 2)
net <- network[[1]]

  print(paste("minimum number of datapoints allowed to include variable combinations in network:",
              min.n))
  print(paste("number of variable combinations in network:", dim(net.d)[1]))
  print(paste("number of modules in network:", length(unique(net$module))))

par(las = 2, mar = c(8,4,1,1))
barplot(table(net$role)/sum(table(net$role)))
```

```{r, echo=F, message=FALSE, warning= F, results = "asis"}
print(kable(net[order(net$participation, decreasing = T),]))

```

#### Minimum n = 50
```{r, echo=F, message=FALSE, warning= F}

min.n <- 50
net.d <- res[!is.na(res$phylocor), c("var1", "var2", "phylocor", "n")]
net.d <- net.d[net.d$n > min.n, -4]
net.list <- as.list(net.d)
network <- netcarto(web = net.list, seed = 2)
net <- network[[1]]

  print(paste("minimum number of datapoints allowed to include variable combinations in network:",
              min.n))
  print(paste("number of variable combinations in network:", dim(net.d)[1]))
  print(paste("number of modules in network:", length(unique(net$module))))

par(las = 2, mar = c(8,4,1,1))
barplot(table(net$role)/sum(table(net$role)))
```

```{r, echo=F, message=FALSE, warning= F, results = "asis"}
print(kable(net[order(net$participation, decreasing = T),]))

```